{% extends "base.html" %}

{% block extra_js %}
  <script src="/assets/js/starrr.js"></script>
{% endblock extra_js %}

{% block content %}
  <div id="greetings">
    <form action="/sign" method="post" id="guestbookForm">
      <div class="starr"></div>
      <div>
        <textarea id="id_content" class="input-block-level" rows="3"></textarea>
        <input type='hidden' id="id_rating">
      </div>

      <div><input id="submitGuestbook" type="button" class="btn btn-large btn-primary" value="Sign Guestbook"></div>
    </form>

    <br>
    <hr>


    {% for greeting in greetings %}
      <div class="row">
        {% if greeting.author %}
          <b>{{greeting.author.nickname()}}</b> wrote:
        {% else %}
         An anonymous person wrote:
        {% endif %}
        {% if greeting.author == user%}
          <a href="#{{greeting.key.id()}}" class="update" data-pk="{{greeting.key.id()}}"><span class="glyphicon glyphicon-pencil"></span> Update</a>
        {%endif%}
        <div class="greeting">
          <div class='rating-readonly' data-rating={{greeting.rating}}></div>
          <blockquote class="greeting-content">{{ greeting.content }}</blockquote>
        </div>
      </div>
    {% endfor %}
  </div>

  <script type="text/javascript">

    $(document).on('click', '.update', function(ev){

      ev.stopPropagation();
      $('#id_content').val('');
      $('.row').next().find('a.cancel').click();

      $(this).removeClass('update').addClass('cancel').html(
        "<span class='glyphicon glyphicon-remove'></span> Cancel"
      );
      var el = $(this);
      var target = $(this).next();
      var rating = target.find('.rating-readonly').data('rating');

      if(rating == undefined){
        rating = 0;
      }

      target.html(
        "<form id='testForm' action='/sign' method='post'>" +
        "<div class='starlet'></div>" +
        "<textarea id='content' class='input-block-level inline' rows='3'>" +
        target.find('.greeting-content').html() + 
        "</textarea>" +
        "<input id='id' type='hidden' value='" + el.data('pk') + "' />" +
        "<input id='rating' type='hidden' data-prev-rating="+ rating+" value='" + rating + "' /><br>" +
        "<button type='button' id='update-submit' class='btn btn-primary btn-xs'>Save</button><br><br>" +
        "</form>"
      );

      target.find('.starlet').starrr({
        rating: rating,
        change: function(e, value){
          alert(value);
          target.find('#rating').val(value);
        }
      });     

    });

    $(document).on('click','#update-submit', function(ev){
      var el = $(this);
      var form = $(this).closest("form");

      if($.trim(form.find('textarea').val()).length > 1){
        $.ajax({
          type: form.attr('method'),
          url: form.attr('action'),
          data: { 
            "content": form.find('textarea').val(), 
            "rating":form.find('#rating').val(),
            'id': form.find('input').val()
          },
          dataType:'json',
          success: function (data) {
            var target = el.parent().parent();
            target.html(
              '<div class="rating-readonly" data-rating="' + data['rating'] + '"></div>' + 
              '<blockquote class="greeting-content">' + data['content'] + '</blockquote>' 
            );

            target.find('.rating-readonly').starrr({
              readonly:true,
              rating:data['rating']
            });
          },
          complete: function(){
            $('.row').find('a.cancel').click();
          }
        });
      }

    });

    $(document).on('click', '.cancel', function(ev){
      
      ev.stopPropagation();
      $(this).removeClass('cancel').addClass('update').html(
        "<span class='glyphicon glyphicon-pencil'></span> Update"
      );
      var el = $(this);
      var target = el.next().find('#testForm');
      var rating = target.find('#rating').data('prev-rating');

      target.html(
        '<div class="rating-readonly" data-rating="' + rating + '"></div>' + 
        '<blockquote class="greeting-content">' + target.find('textarea').html() + '</blockquote>' 
      );

      target.find('.rating-readonly').starrr({
          readonly:true,
          rating:rating
        });
    });

    $(document).on('keypress', 'textarea.inline', function(ev){
      var key = ev.which;
      var el = $(this);

      if(key == 13){
        var form = $(this).closest("form");

        if($.trim(form.find('textarea').val()).length > 1){
          $.ajax({
            type: form.attr('method'),
            url: form.attr('action'),
            data: { 
              "content": form.find('textarea').val(), 
              "rating":form.find('#rating').val(),
              'id': form.find('input').val()
            },
            dataType:'json',
            success: function (data) {
              el.parent().parent().html(
                '<blockquote class="greeting-content">' + data['content'] + '</blockquote>' 
              );
            },
            complete: function(){
              $('.row').find('a.cancel').click();
            }
          });
        }
      }
    });


    $("#guestbookForm").submit(function(ev){
      ev.preventDefault();

      var content = $('#id_content');
      if($.trim(content.val()).length > 1){
        $.ajax({
          type: $(this).attr('method'),
          url: $(this).attr('action'),
          data: { "content": content.val()},
          dataType:'json',
          success: function (data) {

            if(data['author'] == null){
              $('div.row').after(
                '<div class="row">' +
                'An anonymous person wrote:' +
                '  <blockquote>' + data['content'] + '</blockquote>' +
                '</div>'
              );

            }else {
              $('div.row').before(
                '<div class="row">' +
                '  <b>' + data['author'] + '</b> wrote:' +
                '  <blockquote>' + data['content'] + '</blockquote>' +
                '</div>'
              ); 

            }
            $('#id_content').val('');
          }
        });  
      }
    });

    $(".starr").starrr();
    $('.starrr').on('starrr:change', function(e, value){
      $('#id_rating').val(value);
    });

    $(".rating-readonly").starrr(
      {readonly:true}
    );

    $('#submitGuestbook').click(function(){
      $('#guestbookForm').submit();
    });

  </script>
{% endblock %}